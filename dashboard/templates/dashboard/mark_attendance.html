<!DOCTYPE html>
<html lang="en" data-theme="{{ theme }}">

<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RollVision - Mark Attendance</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/modern-style.css' %}">
</head>

<body>

    <!-- Sidebar -->
    {% include 'dashboard/_sidebar.html' %}

    <!-- ================= CONTENT ================= -->
    <div class="content">
        <h4 class="mb-4"><i class="fas fa-video me-2"></i>Mark Attendance</h4>

        <!-- Stats Cards -->
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card card-custom p-3">
                    <div class="d-flex align-items-center">
                        <div class="icon-circle bg-primary me-3">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <div>
                            <small class="text-muted">Total Students</small>
                            <h5 class="fw-bold mb-0">{{ total_students }}</h5>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-custom p-3">
                    <div class="d-flex align-items-center">
                        <div class="icon-circle text-success me-3">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div>
                            <small class="text-muted">Present Today</small>
                            <h5 class="fw-bold mb-0" id="presentCount">{{ present_today }}</h5>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card card-custom p-3">
                    <div class="d-flex align-items-center">
                        <div class="icon-circle text-danger me-3">
                            <i class="fas fa-user-times"></i>
                        </div>
                        <div>
                            <small class="text-muted">Absent Today</small>
                            <h5 class="fw-bold mb-0" id="absentCount">{{ absent_today }}</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Attendance Marking Card -->
        <div class="card card-custom p-4">
            <h5 class="mb-3"><i class="fas fa-camera me-2"></i>Facial Recognition Attendance</h5>

            <div class="row">
                <div class="col-md-8">
                    <!-- Webcam Feed -->
                    <div class="text-center mb-3">
                        <div class="position-relative d-inline-block">
                            <video id="attendanceWebcam" width="640" height="480" autoplay
                                class="border rounded bg-dark"></video>
                            <div id="detectionOverlay" class="position-absolute top-0 start-0 w-100 h-100"
                                style="pointer-events: none;"></div>
                        </div>
                    </div>

                    <div class="text-center">
                        <button class="btn btn-primary btn-lg me-2" id="startWebcamBtn"
                            onclick="startAttendanceWebcam()">
                            <i class="fas fa-video me-2"></i>Start Camera
                        </button>
                        <button class="btn btn-success btn-lg" id="markAttendanceBtn" onclick="markAttendance()"
                            style="display:none;">
                            <i class="fas fa-check-circle me-2"></i>Mark Attendance
                        </button>
                        <button class="btn btn-danger btn-lg" id="stopWebcamBtn" onclick="stopAttendanceWebcam()"
                            style="display:none;">
                            <i class="fas fa-stop-circle me-2"></i>Stop Camera
                        </button>
                    </div>

                    <div id="statusMessage" class="alert mt-3" style="display:none;"></div>
                </div>

                <div class="col-md-4">
                    <!-- Recent Attendance -->
                    <div class="card bg-light p-3">
                        <h6 class="fw-bold mb-3"><i class="fas fa-clock me-2"></i>Last Recognized</h6>
                        <div id="recentAttendance">
                            <p class="text-muted text-center">No attendance marked yet</p>
                        </div>
                    </div>

                    <!-- Instructions -->
                    <div class="card bg-info bg-opacity-10 p-3 mt-3">
                        <h6 class="fw-bold mb-2"><i class="fas fa-info-circle me-2"></i>Instructions</h6>
                        <ol class="small mb-0">
                            <li>Click "Start Camera"</li>
                            <li>Position your face in frame</li>
                            <li>Click "Mark Attendance"</li>
                            <li>Wait for recognition</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Face Capture JavaScript -->
    <script src="{% static 'js/face_capture.js' %}"></script>

    <script>
        let isWebcamActive = false;

        async function startAttendanceWebcam() {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.style.display = 'block';
            statusDiv.className = 'alert alert-info mt-3';
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Starting camera...';

            const result = await faceCapture.startWebcam('attendanceWebcam');

            if (result.success) {
                isWebcamActive = true;
                document.getElementById('startWebcamBtn').style.display = 'none';
                document.getElementById('markAttendanceBtn').style.display = 'inline-block';
                document.getElementById('stopWebcamBtn').style.display = 'inline-block';
                statusDiv.className = 'alert alert-success mt-3';
                statusDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i>Camera started! Position your face and click "Mark Attendance"';
            } else {
                statusDiv.className = 'alert alert-danger mt-3';
                statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>' + result.message;
            }
        }

        function stopAttendanceWebcam() {
            faceCapture.stopWebcam();
            isWebcamActive = false;
            document.getElementById('startWebcamBtn').style.display = 'inline-block';
            document.getElementById('markAttendanceBtn').style.display = 'none';
            document.getElementById('stopWebcamBtn').style.display = 'none';
            document.getElementById('statusMessage').style.display = 'none';
        }

        async function markAttendance() {
            if (!isWebcamActive) {
                showNotification('Please start the camera first', 'warning');
                return;
            }

            const statusDiv = document.getElementById('statusMessage');
            statusDiv.className = 'alert alert-info mt-3';
            statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing face recognition...';

            const markBtn = document.getElementById('markAttendanceBtn');
            markBtn.disabled = true;

            try {
                // Capture current frame
                const faceImage = faceCapture.captureFrame();

                // Send to backend
                const result = await processAttendance(faceImage);

                if (result.success) {
                    // Update stats counters
                    let newPresentCount = 0;

                    // Build status message
                    let messageHtml = `<i class="fas fa-check-circle me-2"></i><strong>${result.message}</strong><br>`;
                    messageHtml += '<ul class="mb-0 mt-2">';

                    result.results.forEach(student => {
                        const statusColor = student.status === 'already_marked' ? 'text-warning' : 'text-success';
                        const icon = student.status === 'already_marked' ? 'fa-exclamation-circle' : 'fa-check';

                        messageHtml += `
                            <li>
                                <span class="${statusColor}">
                                    <i class="fas ${icon} me-1"></i>
                                    ${student.name} (${student.student_id})
                                </span>
                                - ${student.time}
                            </li>
                        `;

                        // Update recent list
                        updateRecentAttendance(student, student.time);

                        if (student.status === 'marked') {
                            newPresentCount++;
                        }
                    });

                    messageHtml += '</ul>';

                    statusDiv.className = 'alert alert-success mt-3';
                    statusDiv.innerHTML = messageHtml;

                    // Update stats
                    if (newPresentCount > 0) {
                        const presentCount = document.getElementById('presentCount');
                        const currentPresent = parseInt(presentCount.textContent);
                        presentCount.textContent = currentPresent + newPresentCount;

                        const absentCount = document.getElementById('absentCount');
                        const currentAbsent = parseInt(absentCount.textContent);
                        absentCount.textContent = Math.max(0, currentAbsent - newPresentCount);
                    }

                    showNotification('Attendance marked successfully!', 'success');
                } else {
                    statusDiv.className = 'alert alert-warning mt-3';
                    statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>' + result.message;
                }
            } catch (error) {
                statusDiv.className = 'alert alert-danger mt-3';
                statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Error: ' + error.message;
            } finally {
                markBtn.disabled = false;
            }
        }

        function updateRecentAttendance(student, time) {
            const recentDiv = document.getElementById('recentAttendance');
            recentDiv.innerHTML = `
        <div class="border-start border-success border-4 ps-3 mb-2">
            <strong>${student.name}</strong><br>
            <small class="text-muted">${student.student_id} - ${student.class_year}</small><br>
            <small class="text-success"><i class="fas fa-clock me-1"></i>${time}</small>
        </div>
    ` + recentDiv.innerHTML;
        }

        // Auto-start camera on page load
        window.addEventListener('load', function () {
            // Optionally auto-start camera
            // startAttendanceWebcam();
        });
    </script>

</body>

</html>