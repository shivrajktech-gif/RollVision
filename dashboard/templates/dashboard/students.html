<!DOCTYPE html>
<html lang="en" data-theme="{{ theme }}">

<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RollVision - Students</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="{% static 'css/modern-style.css' %}">
</head>

<body>

    <!-- Sidebar -->
    {% include 'dashboard/_sidebar.html' %}

    <!-- ================= CONTENT ================= -->
    <div class="content">
        <h4 class="mb-4">Students</h4>
        {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
        {% endif %}

        <!-- ================= STUDENT STATS ================= -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card card-custom p-3">
                    <div class="d-flex align-items-center">
                        <div class="icon-circle bg-purple me-3">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <div>
                            <small class="text-muted">Total Students</small>
                            <h5 class="fw-bold mb-0">{{ total_students }}</h5>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card card-custom p-3">
                    <div class="d-flex align-items-center">
                        <div class="icon-circle me-3 text-primary">
                            <i class="fas fa-user-check"></i>
                        </div>


                        <div>
                            <small class="text-muted">Present Today</small>
                            <h5 class="fw-bold mb-0">{{ present_today }}</h5>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card card-custom p-3">
                    <div class="d-flex align-items-center">
                        <div class="icon-circle me-3 text-danger">
                            <i class="fas fa-user-times"></i>
                        </div>


                        <div>
                            <small class="text-muted">Absent Today</small>
                            <h5 class="fw-bold mb-0">{{ absent_today }}</h5>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3">
                <div class="card card-custom p-3">
                    <div class="d-flex align-items-center">
                        <div class="icon-circle me-3 text-warning">
                            <i class="fas fa-chart-line"></i>
                        </div>


                        <div>
                            <small class="text-muted">Attendance Rate</small>
                            <h5 class="fw-bold mb-0">{{ attendance_rate }}%</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================= REGISTER STUDENT ================= -->
        <div class="card card-custom p-4">
            <h5 class="mb-3">Register Student</h5>

            <form method="POST" action="{% url 'students' %}" enctype="multipart/form-data" id="studentForm">
                {% csrf_token %}

                <!-- Student ID -->
                <div class="mb-3">
                    <label class="form-label">Student ID <span class="text-danger">*</span></label>
                    <input type="text" name="student_id" class="form-control" placeholder="Enter ID" required
                        pattern="[A-Za-z0-9]+" title="Student ID should contain only letters and numbers">
                </div>

                <!-- Roll Number -->
                <div class="mb-3">
                    <label class="form-label">Roll Number <span class="text-danger">*</span></label>
                    <input type="text" name="roll_number" class="form-control" placeholder="Enter Roll Number" required
                        maxlength="10">
                    <small class="form-text text-muted">Roll number within division</small>
                </div>

                <!-- Full Name -->
                <div class="mb-3">
                    <label class="form-label">Full Name <span class="text-danger">*</span></label>
                    <input type="text" name="name" class="form-control" placeholder="Enter Full Name" required
                        minlength="2">
                </div>

                <!-- Email -->
                <div class="mb-3">
                    <label class="form-label">Email <span class="text-danger">*</span></label>
                    <input type="email" name="email" class="form-control" placeholder="Enter Email" required>
                </div>

                <!-- Phone Number -->
                <div class="mb-3">
                    <label class="form-label">Phone Number <span class="text-danger">*</span></label>
                    <input type="tel" name="phone_number" class="form-control" placeholder="Enter Phone Number" required
                        pattern="\+?1?\d{9,15}" title="Phone number must be 9-15 digits">
                    <small class="form-text text-muted">Primary contact number (9-15 digits)</small>
                </div>

                <!-- Secondary Phone Number (Optional) -->
                <div class="mb-3">
                    <label class="form-label">Secondary Phone Number <span class="text-muted">(Optional)</span></label>
                    <input type="tel" name="secondary_phone" class="form-control"
                        placeholder="Enter Secondary Phone Number" pattern="\+?1?\d{9,15}"
                        title="Phone number must be 9-15 digits">
                    <small class="form-text text-muted">Optional secondary contact number</small>
                </div>

                <!-- Class -->
                <div class="mb-3">
                    <label class="form-label">Class Year <span class="text-danger">*</span></label>
                    <select name="class_year" class="form-select" required>
                        <option value="">Select Class Year</option>
                        <option value="FE">FE</option>
                        <option value="SE">SE</option>
                        <option value="TE">TE</option>
                        <option value="BE">BE</option>
                    </select>
                </div>

                <!-- Department -->
                <div class="mb-3">
                    <label class="form-label">Department <span class="text-danger">*</span></label>
                    <select name="department" class="form-select" required>
                        <option value="">Select Department</option>
                        {% for dept in departments %}
                        <option value="{{ dept.id }}">{{ dept.code }} - {{ dept.name }}</option>
                        {% endfor %}
                    </select>
                    <small class="form-text text-muted">Academic department</small>
                </div>

                <!-- Division -->
                <div class="mb-3">
                    <label class="form-label">Division <span class="text-danger">*</span></label>
                    <select name="division" class="form-select" required>
                        <option value="">Select Division</option>
                        {% for div in divisions %}
                        <option value="{{ div.id }}">{{ div.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Face Registration Method -->
                <div class="mb-4">
                    <label class="form-label fw-bold">Face Registration Method</label>
                    <div class="mt-2">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="face_method" id="methodCamera"
                                value="camera" checked onchange="toggleFaceMethod()">
                            <label class="form-check-label" for="methodCamera">
                                <i class="fas fa-camera me-1"></i> Capture from Camera
                            </label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="face_method" id="methodUpload"
                                value="upload" onchange="toggleFaceMethod()">
                            <label class="form-check-label" for="methodUpload">
                                <i class="fas fa-upload me-1"></i> Upload Photo
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Camera Capture Option -->
                <div id="cameraOption" class="mb-4">
                    <button type="button" class="btn btn-warning" id="captureFaceBtn" onclick="openFaceCaptureModal()">
                        <i class="fas fa-camera me-1"></i> Capture Face from Camera
                    </button>
                    <input type="hidden" id="face_data" name="face_data">
                </div>

                <!-- Photo Upload Option -->
                <div id="uploadOption" class="mb-4" style="display:none;">
                    <label class="form-label">Upload Student Photo</label>
                    <input type="file" name="photo" id="photoUpload" class="form-control" accept="image/*"
                        onchange="previewUploadedPhoto()">
                    <small class="text-muted">Supported: JPG, PNG. Clear frontal face photo recommended.</small>
                    <div id="photoPreview" class="mt-3" style="display:none;">
                        <p class="text-success"><i class="fas fa-check-circle me-1"></i> Photo uploaded successfully!
                        </p>
                        <img id="previewImage" width="200" height="150" class="border rounded">
                    </div>
                </div>

                <!-- Submit Button -->
                <div>
                    <button type="submit" class="btn btn-primary" id="registerBtn">
                        <i class="fas fa-user-plus me-1"></i> Register Student
                    </button>
                </div>
            </form>
        </div>

        <!-- ================= STUDENT LIST ================= -->
        <div class="card card-custom p-4 mt-4">
            <h5 class="mb-3">Registered Students ({{ total_students }})</h5>

            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Roll No</th>
                            <th>Name</th>
                            <th>Class</th>
                            <th>Department</th>
                            <th>Division</th>
                            <th>Phone</th>
                            <th>Email</th>
                            <th>Face Trained</th>
                            <th>Registered On</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for student in students %}
                        <tr>
                            <td><strong>{{ student.student_id }}</strong></td>
                            <td>{{ student.roll_number }}</td>
                            <td>{{ student.name }}</td>
                            <td><span class="badge bg-primary">{{ student.class_year }}</span></td>
                            <td>{{ student.department.code|default:"N/A" }}</td>
                            <td>{{ student.division.name|default:"N/A" }}</td>
                            <td>{{ student.phone_number }}</td>
                            <td>{{ student.email }}</td>
                            <td>
                                {% if student.is_trained %}
                                <span class="badge bg-success"><i class="fas fa-check"></i> Yes</span>
                                {% else %}
                                <span class="badge bg-warning"><i class="fas fa-times"></i> No</span>
                                {% endif %}
                            </td>
                            <td>{{ student.created_at|date:"d M Y" }}</td>
                            <td>
                                <button class="btn btn-sm btn-danger"
                                    onclick="confirmDelete('{{ student.id }}', '{{ student.name }}', '{{ student.student_id }}')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="11" class="text-center text-muted">No students registered yet. Use the form
                                above to register students.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {% if students.count > 100 %}
            <p class="text-muted text-center mt-2">Showing recent 100 students. Total: {{ total_students }}</p>
            {% endif %}
        </div>
    </div>

    <!-- Face Capture Modal -->
    <div class="modal fade" id="faceCaptureModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-camera me-2"></i>Capture Face</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="text-muted">Position your face in the camera frame and click Capture</p>

                    <!-- Webcam Video -->
                    <div class="position-relative d-inline-block">
                        <video id="webcamVideo" width="640" height="480" autoplay class="border rounded"></video>
                        <div id="faceDetectionIndicator" class="position-absolute top-0 start-0 w-100 h-100"
                            style="display:none; border: 3px solid lime;"></div>
                    </div>

                    <!-- Captured Image Preview -->
                    <div id="capturedImageContainer" style="display:none;" class="mt-3">
                        <p class="text-success"><i class="fas fa-check-circle me-2"></i>Face captured successfully!</p>
                        <img id="capturedImage" width="320" height="240" class="border rounded">
                    </div>

                    <div id="cameraStatus" class="alert alert-info mt-3" style="display:none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="captureBtn" onclick="captureFace()">
                        <i class="fas fa-camera me-1"></i> Capture
                    </button>
                    <button type="button" class="btn btn-success" id="useFaceBtn" style="display:none;"
                        onclick="useCapturedFace()">
                        <i class="fas fa-check me-1"></i> Use This Face
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Confirm Delete</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Are you sure you want to delete <strong id="deleteStudentName"></strong> (<strong
                            id="deleteStudentSid"></strong>)?</p>
                    <div class="alert alert-warning mb-0">
                        <strong>⚠️ This will permanently delete:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Student record</li>
                            <li>Face encodings</li>
                            <li>All attendance history</li>
                        </ul>
                        <p class="mb-0 mt-2"><strong>This action cannot be undone!</strong></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                        <i class="fas fa-trash-alt me-1"></i> Delete Student
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Face Capture JavaScript -->
    {% load static %}
    <script src="{% static 'js/face_capture.js' %}"></script>

    <script>
        let faceCaptureModal;
        let capturedFaceDataGlobal = null;

        // Initialize modal
        document.addEventListener('DOMContentLoaded', function () {
            faceCaptureModal = new bootstrap.Modal(document.getElementById('faceCaptureModal'));
        });

        // Open face capture modal
        async function openFaceCaptureModal() {
            // Reset state
            document.getElementById('capturedImageContainer').style.display = 'none';
            document.getElementById('captureBtn').style.display = 'inline-block';
            document.getElementById('useFaceBtn').style.display = 'none';
            capturedFaceDataGlobal = null;

            // Show modal
            faceCaptureModal.show();

            // Start webcam
            const statusDiv = document.getElementById('cameraStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = 'alert alert-info mt-3';
            statusDiv.textContent = 'Starting webcam...';

            const result = await faceCapture.startWebcam('webcamVideo');

            if (result.success) {
                statusDiv.style.display = 'none';
            } else {
                statusDiv.className = 'alert alert-danger mt-3';
                statusDiv.textContent = result.message;
            }
        }

        // Capture face from webcam
        function captureFace() {
            try {
                const imageData = faceCapture.captureFrame();
                capturedFaceDataGlobal = imageData;

                // Display captured image
                document.getElementById('capturedImage').src = imageData;
                document.getElementById('capturedImageContainer').style.display = 'block';

                // Update buttons
                document.getElementById('captureBtn').style.display = 'none';
                document.getElementById('useFaceBtn').style.display = 'inline-block';

            } catch (error) {
                showNotification('Error capturing face: ' + error.message, 'danger');
            }
        }

        // Use captured face and close modal
        function useCapturedFace() {
            if (capturedFaceDataGlobal) {
                document.getElementById('face_data').value = capturedFaceDataGlobal;
                document.getElementById('captureFaceBtn').innerHTML = '<i class="fas fa-check-circle me-1"></i> Face Captured';
                document.getElementById('captureFaceBtn').classList.remove('btn-warning');
                document.getElementById('captureFaceBtn').classList.add('btn-success');

                faceCapture.stopWebcam();
                faceCaptureModal.hide();
                showNotification('Face captured! Now complete the form and register.', 'success');
            }
        }

        // Toggle between camera and upload options
        function toggleFaceMethod() {
            const method = document.querySelector('input[name="face_method"]:checked').value;
            const cameraOption = document.getElementById('cameraOption');
            const uploadOption = document.getElementById('uploadOption');

            if (method === 'camera') {
                cameraOption.style.display = 'block';
                uploadOption.style.display = 'none';
                // Clear upload
                document.getElementById('photoUpload').value = '';
                document.getElementById('photoPreview').style.display = 'none';
            } else {
                cameraOption.style.display = 'none';
                uploadOption.style.display = 'block';
                // Clear camera data
                document.getElementById('capturedFaceData').value = '';
                document.getElementById('captureFaceBtn').innerHTML = '<i class="fas fa-camera me-1"></i> Capture Face from Camera';
                document.getElementById('captureFaceBtn').classList.remove('btn-success');
                document.getElementById('captureFaceBtn').classList.add('btn-warning');
            }
        }

        // Preview uploaded photo
        function previewUploadedPhoto() {
            const fileInput = document.getElementById('photoUpload');
            const file = fileInput.files[0];

            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('photoPreview').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // Handle modal close
        document.getElementById('faceCaptureModal').addEventListener('hidden.bs.modal', function () {
            faceCapture.stopWebcam();
        });

        // Handle form submission - SIMPLIFIED (No AJAX!)
        document.querySelector('form').addEventListener('submit', function (e) {
            const studentId = document.querySelector('input[name="student_id"]').value;
            const faceMethod = document.querySelector('input[name="face_method"]:checked').value;
            const faceData = document.getElementById('face_data').value;
            const photoFile = document.getElementById('photoUpload').files[0];

            // Validation only - backend handles everything else!
            if (!studentId) {
                e.preventDefault();
                showNotification('Please enter Student ID', 'warning');
                return;
            }

            // Check if face is provided via either method
            if (faceMethod === 'camera' && !faceData) {
                e.preventDefault();
                showNotification('Please capture face from camera before registering', 'warning');
                return;
            }

            if (faceMethod === 'upload' && !photoFile) {
                e.preventDefault();
                showNotification('Please upload a photo before registering', 'warning');
                return;
            }

            // Let form submit normally - backend handles EVERYTHING in one atomic transaction!
            // No AJAX, no complexity, 100% reliable!
            const registerBtn = document.getElementById('registerBtn');
            registerBtn.disabled = true;
            registerBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Registering...';
        });

        // Delete confirmation modal
        let deleteConfirmModal;
        let deleteStudentIdGlobal = null;

        // Initialize delete modal
        document.addEventListener('DOMContentLoaded', function () {
            deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));

            // Handle confirm delete button click
            document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
                if (deleteStudentIdGlobal) {
                    window.location.href = `/students/delete/${deleteStudentIdGlobal}/`;
                }
            });
        });

        // Show delete confirmation modal
        function confirmDelete(studentId, studentName, studentSid) {
            // Store student ID for deletion
            deleteStudentIdGlobal = studentId;

            // Update modal content
            document.getElementById('deleteStudentName').textContent = studentName;
            document.getElementById('deleteStudentSid').textContent = studentSid;

            // Show modal
            deleteConfirmModal.show();
        }
    </script>

</body>

</html>